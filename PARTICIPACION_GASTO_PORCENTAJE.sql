MERGE INTO SCH01.GPV_ACT T1
USING (
    WITH MINIMO AS (
        SELECT GPV.GPV_NUM_GASTO_HAYA, GA.GPV_ID, GA.ACT_ID, ROW_NUMBER() OVER(PARTITION BY GA.GPV_ID ORDER BY NVL(GA.GPV_PARTICIPACION_GASTO,0)) RN
        FROM SCH01.GPV_GASTOS_PROVEEDOR GPV
        JOIN SCH01.GPV_ACT GA ON GPV.GPV_ID = GA.GPV_ID
        )
    , DIFERENCIA AS (
        SELECT 100 - SUM(GA.GPV_PARTICIPACION_GASTO) GPV_DIFF_PART, GA.GPV_ID
        FROM SCH01.GPV_ACT GA
        GROUP BY GA.GPV_ID
        )
    SELECT MIN.GPV_ID, MIN.ACT_ID, DIF.GPV_DIFF_PART
    FROM MINIMO MIN
    JOIN DIFERENCIA DIF ON DIF.GPV_ID = MIN.GPV_ID
    WHERE MIN.RN = 1 AND 
        MIN.GPV_NUM_GASTO_HAYA IN (9722413,9722418,9724354,9724360,9724362,9724979,9724395,9724929,9725016,9728739,9728679,9728683,9728758,9728766,9729867,9729868,9729873,9722406,9722407,9723181,9723185,9723187,9723194,9724957,9724961,9724983,9724981,9698207,9730171,9730179,9729916,4342246,9647816)
    ) T2
ON (T1.GPV_ID = T2.GPV_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.GPV_PARTICIPACION_GASTO = T1.GPV_PARTICIPACION_GASTO + T2.GPV_DIFF_PART
    , T1.VERSION = T1.VERSION + 1
WHERE T2.GPV_DIFF_PART <> 0;
